name: CI

on:
    push:
        branches: [main, "001-create-prosepad-editor"]
    pull_request:
        branches: [main]

jobs:
    lint-and-install:
        name: Install & Lint (frontend + backend)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
            - name: Install backend deps
              run: npm --prefix backend ci
            - name: Install frontend deps
              run: npm --prefix frontend ci
            - name: Lint backend
              run: npm --prefix backend run lint
            - name: Lint frontend
              run: npm --prefix frontend run lint

    test:
        name: Unit & Integration Tests
        runs-on: ubuntu-latest
        needs: lint-and-install
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
            - name: Install dependencies
              run: |
                  npm --prefix backend ci
                  npm --prefix frontend ci
            - name: Run backend tests
              run: npm --prefix backend test
            - name: Run frontend tests
              run: npm --prefix frontend test

    build-frontend:
        name: Build Frontend
        runs-on: ubuntu-latest
        needs: lint-and-install
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
            - name: Install frontend deps
              run: npm --prefix frontend ci
            - name: Build
              run: npm --prefix frontend run build

    security-scan:
        name: Security Scan (npm audit)
        runs-on: ubuntu-latest
        needs: lint-and-install
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
            - name: Install deps
              run: |
                  npm --prefix backend ci
                  npm --prefix frontend ci
            - name: Audit backend
              run: npm --prefix backend audit --audit-level=moderate || true
            - name: Audit frontend
              run: npm --prefix frontend audit --audit-level=moderate || true

    constitution-check:
        name: Constitution Check
        runs-on: ubuntu-latest
        needs: lint-and-install
        steps:
            - uses: actions/checkout@v4
            - name: Verify plan and constitution files exist
              run: |
                  test -f specs/001-create-prosepad-editor/plan.md || (echo "Missing plan.md" && exit 1)
                  test -f specs/001-create-prosepad-editor/spec.md || (echo "Missing spec.md" && exit 1)
                  test -f .specify/memory/constitution.md || (echo "Missing constitution.md" && exit 1)
            - name: Basic plan validation
              run: |
                  grep -q "Backend" specs/001-create-prosepad-editor/plan.md || echo "Note: plan does not mention backend"
